# Jvm面试题

## 创建对象的几种方式

1. 使用new关键字  
2. 使用Class类的newInstance方法(User.class.newInstance();)  
3. 使用Constructor类的newInstance方法(User.class.getConstructor()..newInstance())  
4. 使用clone方法  
5. 使用反序列化  

## 创建对象的过程

1. 虚拟机遇到new指令，到常量池定位到这个类的符号引用。  
2. 检查符号引用代表的类是否被加载、解析、初始化过。  
3. 虚拟机为对象分配内存。一种办法“指针碰撞”、一种办法“空闲列表”，最终常用的办法“本地线程缓冲分配(TLAB)”。  
    **TLAB一般有两种解决方案：**  
    - 对分配内存空间的动作做同步处理，采用CAS机制，配合失败重试的方式保证更新操作的原子性。  
    - 每个线程在Java堆中预先分配一小块内存，然后再给对象分配内存的时候，直接在自己这块”私有”内存中分配，当这部分区域用完之后，再分配新的"私有"内存。这部分内存称之为TLAB。这块内存的分配时线程独占的，读取、使用、回收是线程共享的。  
    - JIT经过逃逸分析，发现有些对象没有逃逸出方法，那么有可能堆内存分配会被优化成栈内存分配  
4. 虚拟机将分配到的内存空间都初始化为零值。（对象头外的对象内存空间初始化为 0）  
5. 虚拟机对对象进行必要的设置。  
6. 执行方法，成员变量进行初始化。

## JVM运行时数据区域

1. **程序计数器**  
线程私有。    
程序计数器可以当作是当前线程所执行的行号指示器，工作时候通过改变这个计数器的值来选取下一条需要执行的字节码指令。程序控制流：分支，循环，跳转，异常处理，线程恢复等。  
如果该线程执行的是一个Java方法，计数器记录的是正在执行的虚拟机字节码指令的地址；如果正在执行的是本地(Native)方法，这个计数器值应该为空。  
2. **Java虚拟机栈**  
线程私有。-Xss  
每个方法执行的时候，会同步创建一个栈帧用于存放局部变量表，操作数栈，动态连接，方法出口等信息。  
每个方法被调用直至执行完毕的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。  
局部变量表：Java虚拟机的基本数据类型，对象引用（指向对象起始地址的引用指针，句柄或者相关位置）和returnAddress类型（指向一条字节码的地址）
3. **Java本地方法栈**  
执行Java方法（Native）
4. **Java堆**  
   线程共享。对象实例和数组。-Xms -Xmx
5. **方法区**  
   线程共享。-XX:MetaspaceSize，被虚拟机加载的类型信息，常量，静态常量，即时编译器编译后的代码缓存等数据。
运行时常量池：常量池表: 编译期生成的各种字面量和符号引用。也有动态，String.intern()
6. **直接内存**  
   NIO，基于管道于缓存的IO方式，Native直接分配堆外内存。Channel和Buffer的I/O方式，可以使用Native函数直接分配堆外内存，然后通过一个存储在Java堆中的DirectByteBuffer。