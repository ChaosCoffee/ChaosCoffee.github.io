<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="Cache-Control" content="no-transform"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="apple-mobile-web-app-capable" content="ChaosCoffee&#39; blog"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="browsermode" content="application"><meta name="screen-orientation" content="portrait"><link rel="dns-prefetch" href="https://chaoscoffee.github.io"><meta name="robots" content="all"><meta name="google" content="all"><meta name="googlebot" content="all"><meta name="verify" content="all"><title>Ingress-实践 | ChaosCoffee&#39; blog</title><link rel="alternate" href="/atom.xml" title="ChaosCoffee&#39; blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/bootstrap.min.css?rev=01db7b9bef05ad753ff3280573311707"><link rel="stylesheet" href="/css/font-awesome.min.css?rev=7d7c67beb5a3ece63f0a947be957099b"><link rel="stylesheet" href="/css/style.css?rev=5e007e24b2eddf2cb1d77fa3b2664f4b"><div class="hide"><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"))</script></div></head><!--[if lte IE 8]><style>
    html{ font-size: 1em }
</style><![endif]--><!--[if lte IE 9]><div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div><![endif]--><body><header class="main-header" style="background-image:url(/img/banner2.jpg)"><div class="main-header-box"><a class="header-avatar" href="/" title="ChaoCofee"><img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block"></a><div class="branding"><img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block"></div></div></header><nav class="main-navigation"><div class="container"><div class="row"><div class="col-sm-12"><div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav"><span class="sr-only"></span><i class="fa fa-bars"></i></span> <a class="navbar-brand" href="https://chaoscoffee.github.io">ChaosCoffee&#39; blog</a></div><div class="collapse navbar-collapse" id="main-menu"><ul class="menu"><li role="presentation" class="text-center"><a href="/"><i class="fa fa-home"></i> Home</a></li><li role="presentation" class="text-center"><a href="/categories/programmes/"><i class="fa fa-github"></i> Programmes</a></li><li role="presentation" class="text-center"><a href="/categories/tools/"><i class="fa fa-wrench"></i> Tools</a></li><li role="presentation" class="text-center"><a href="/categories/interview/"><i class="fa fa-user"></i> 求职面试</a></li><li role="presentation" class="text-center"><a href="/archives/"><i class="fa fa-calendar"></i> 时间轴</a></li></ul></div></div></div></div></nav><section class="content-wrap"><div class="container"><div class="row"><main class="col-md-8 main-content m-post"><p id="process"></p><article class="post"><div class="post-head"><h1 id="Ingress-实践">Ingress-实践</h1><div class="post-meta"><span class="categories-meta fa-wrap"><i class="fa fa-folder-open-o"></i> <a href="/categories/kubernetes">kubernetes</a></span><span class="fa-wrap"><i class="fa fa-tags"></i> <span class="tags-meta"><a href="/tags/kubernetes" title="kubernetes">kubernetes</a></span></span><span class="fa-wrap"><i class="fa fa-clock-o"></i> <span class="date-meta">2018/08/10</span></span></div></div><div class="post-body post-content"><h1 id="Ingress-实践"><a href="#Ingress-实践" class="headerlink" title="Ingress 实践"></a>Ingress 实践</h1><ul><li><a href="#ingress-%E5%AE%9E%E8%B7%B5">Ingress 实践</a><ul><li><a href="#kubernetes-%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1%E6%96%B9%E5%BC%8F">Kubernetes 暴露服务方式</a><ul><li><a href="#loadblancer-service">LoadBlancer Service</a></li><li><a href="#nodeport-service">NodePort Service</a></li><li><a href="#ingress">Ingress</a></li></ul></li><li><a href="#ingress-%E4%BB%8B%E7%BB%8D">Ingress 介绍</a></li><li><a href="#ingress-%E9%83%A8%E7%BD%B2">Ingress 部署</a><ul><li><a href="#default-backend">default-backend</a></li><li><a href="#ingress-controller">Ingress Controller</a></li><li><a href="#%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2">快速部署</a><ul><li><a href="#%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90">创建相关资源</a></li><li><a href="#%E5%88%9B%E5%BB%BAingress-nginx%E6%9C%8D%E5%8A%A1">创建ingress-nginx服务</a></li><li><a href="#%E6%B5%8B%E8%AF%95">测试</a></li></ul></li></ul></li><li><a href="#%E9%85%8D%E7%BD%AEtls-ssl%E8%AE%BF%E9%97%AE">配置TLS SSL访问</a><ul><li><a href="#%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6">创建证书</a></li><li><a href="#%E5%88%9B%E5%BB%BA-secret">创建 Secret</a></li><li><a href="#%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA-secret">快速创建 Secret</a></li><li><a href="#%E9%87%8D%E6%96%B0%E9%83%A8%E7%BD%B2">重新部署</a></li></ul></li><li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3">参考文档</a></li></ul></li></ul><h2 id="Kubernetes-暴露服务方式"><a href="#Kubernetes-暴露服务方式" class="headerlink" title="Kubernetes 暴露服务方式"></a>Kubernetes 暴露服务方式</h2><p>到目前为止 Kubernetes 暴露服务的有三种方式，分别为</p><ul><li>LoadBlancer Service</li><li>NodePort Service</li><li>Ingress</li></ul><h3 id="LoadBlancer-Service"><a href="#LoadBlancer-Service" class="headerlink" title="LoadBlancer Service"></a>LoadBlancer Service</h3><p>LoadBlancer Service 是 Kubernetes 结合云平台的组件，如国外 GCE、AWS、国内阿里云等等，使用它向使用的底层云平台申请创建负载均衡器来实现，有局限性，对于使用云平台的集群比较方便。</p><h3 id="NodePort-Service"><a href="#NodePort-Service" class="headerlink" title="NodePort Service"></a>NodePort Service</h3><p>NodePort Service 是通过在节点上暴漏端口，然后通过将端口映射到具体某个服务上来实现服务暴漏，比较直观方便，但是对于集群来说，随着 Service 的不断增加，需要的端口越来越多，很容易出现端口冲突，而且不容易管理。当然对于小规模的集群服务，还是比较不错的。</p><h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>Ingress解决的是新的服务加入后，域名和服务的对应问题，基本上是一个ingress的对象，通过yaml进行创建和更新进行加载。</p><p>Ingress使用开源的反向代理负载均衡器来实现对外暴漏服务，比如 Nginx、Apache、Haproxy等。Nginx Ingress 一般有三个组件组成：</p><ul><li>Nginx 反向代理负载均衡器</li><li>Ingress Controller<br>Ingress Controller可以理解为控制器，它通过不断的跟 Kubernetes API 交互，实时获取后端 Service、Pod 等的变化，比如新增、删除等，然后结合 Ingress 定义的规则生成配置，然后动态更新上边的 Nginx 负载均衡器，并刷新使配置生效，来达到服务自动发现的作用，简单来说，Ingress这种变化生成一段Nginx的配置，然后将这个配置通过Kubernetes API写到Nginx的Pod中，然后reload</li><li>Ingress<br>Ingress 则是定义规则，通过它定义某个域名的请求过来之后转发到集群中指定的 Service。它可以通过 Yaml 文件定义，可以给一个或多个 Service 定义一个或多个 Ingress 规则。</li></ul><h2 id="Ingress-介绍"><a href="#Ingress-介绍" class="headerlink" title="Ingress 介绍"></a>Ingress 介绍</h2><blockquote><p>官网对 Ingress 的定义为管理对外服务到集群内服务之间规则的集合，通俗点讲就是它定义规则来允许进入集群的请求被转发到集群中对应服务上，从来实现服务暴漏。 Ingress 能把集群内 Service 配置成外网能够访问的 URL，流量负载均衡，终止SSL，提供基于域名访问的虚拟主机等等。</p><p>Ingress解决的是新的服务加入后，域名和服务的对应问题，基本上是一个ingress的对象，通过yaml进行创建和更新进行加载。<br>可以通过ConfigMap提供的Nginx命令修改参数。</p></blockquote><hr><h2 id="Ingress-部署"><a href="#Ingress-部署" class="headerlink" title="Ingress 部署"></a>Ingress 部署</h2><h3 id="default-backend"><a href="#default-backend" class="headerlink" title="default-backend"></a>default-backend</h3><p>default-backend<br>生成一个默认的后端，如果遇到解析不到的URL或者发生错误就转发到默认后端<br>dashboard.yaml<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-weblogic-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: helloworld.eric</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /console</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: helloworldsvc </span><br><span class="line">          servicePort: 7001</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure><p></p><ul><li>host 指虚拟出来的域名，具体地址(Ingress-controller那台Pod所在的主机的地址)应该加入/etc/hosts中,这样所有去helloworld.eric的请求都会发到nginx</li><li>path:/console 匹配后面的应用路径</li><li>servicePort 主要是定义服务的时候的端口，不是NodePort.</li><li>path:/ 匹配后面dashboard应用的路径,以前通过访问master节点8080/ui进入dashboard的，但dashboard其实是部署在minion节点中，实际是通过某个路由语句转发过去而已，dashboard真实路径如下:</li></ul><h3 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h3><blockquote><p>$ kubectl create -f ingress-nginx/examples/deployment/nginx/nginx-ingress-controller.yaml</p></blockquote><h3 id="快速部署"><a href="#快速部署" class="headerlink" title="快速部署"></a>快速部署</h3><h4 id="创建相关资源"><a href="#创建相关资源" class="headerlink" title="创建相关资源"></a>创建相关资源</h4><blockquote><p>$ kubectl apply -f <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml</a></p></blockquote><h4 id="创建ingress-nginx服务"><a href="#创建ingress-nginx服务" class="headerlink" title="创建ingress-nginx服务"></a>创建ingress-nginx服务</h4><blockquote><p>$ kubectl apply -f <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml</a></p></blockquote><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><blockquote><p>$ kubectl get svc -o wide -n ingress-nginx<br>$ kubectl create -f hello-world-deployment.yaml</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata: </span><br><span class="line">name: hello-world-deployment</span><br><span class="line">spec: </span><br><span class="line">replicas: 1</span><br><span class="line">template: </span><br><span class="line">    metadata: </span><br><span class="line">    labels: </span><br><span class="line">        app: hello-world</span><br><span class="line">    spec: </span><br><span class="line">    containers: </span><br><span class="line">        - image: &quot;gokul93/hello-world:latest&quot;</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: hello-world-container</span><br><span class="line">        ports: </span><br><span class="line">            - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata: </span><br><span class="line">name: hello-world-svc</span><br><span class="line">spec: </span><br><span class="line">ports: </span><br><span class="line">    -  port: 8080</span><br><span class="line">        protocol: TCP</span><br><span class="line">        targetPort: 8080</span><br><span class="line">selector: </span><br><span class="line">    app: hello-world</span><br><span class="line">type: NodePort</span><br></pre></td></tr></table></figure><blockquote><p>$ kubectl create -f hello-world-ingress.yaml<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;</span><br><span class="line">creationTimestamp: 2018-08-03T02:51:13Z</span><br><span class="line">generation: 2</span><br><span class="line">name: hello-world-ingress</span><br><span class="line">namespace: default</span><br><span class="line">resourceVersion: &quot;3668608&quot;</span><br><span class="line">selfLink: /apis/extensions/v1beta1/namespaces/default/ingresses/hello-world-ingress</span><br><span class="line">uid: 15b9c53b-96c8-11e8-9920-00505683568f</span><br><span class="line">spec:</span><br><span class="line">rules:</span><br><span class="line">- http:</span><br><span class="line">    paths:</span><br><span class="line">    - backend:</span><br><span class="line">        serviceName: hello-world-svc</span><br><span class="line">        servicePort: 8080</span><br><span class="line">        path: /</span><br></pre></td></tr></table></figure><p></p></blockquote><blockquote><p>$ curl k8s-node-ip:32483/hello</p></blockquote><h2 id="配置TLS-SSL访问"><a href="#配置TLS-SSL访问" class="headerlink" title="配置TLS SSL访问"></a>配置TLS SSL访问</h2><h3 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 生成 CA 自签证书</span><br><span class="line">mkdir cert &amp;&amp; cd cert</span><br><span class="line">openssl genrsa -out ca-key.pem 2048</span><br><span class="line">openssl req -x509 -new -nodes -key ca-key.pem -days 10000 -out ca.pem -subj &quot;/CN=kube-ca&quot;</span><br><span class="line"></span><br><span class="line"># 编辑 openssl 配置</span><br><span class="line">cp /etc/pki/tls/openssl.cnf .</span><br><span class="line">vim openssl.cnf</span><br><span class="line"></span><br><span class="line"># 主要修改如下</span><br><span class="line">[req]</span><br><span class="line">req_extensions = v3_req # 这行默认注释关着的 把注释删掉</span><br><span class="line"># 下面配置是新增的</span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = dashboard.mritd.me</span><br><span class="line">DNS.2 = kibana.mritd.me</span><br><span class="line"></span><br><span class="line"># 生成证书</span><br><span class="line">openssl genrsa -out ingress-key.pem 2048</span><br><span class="line">openssl req -new -key ingress-key.pem -out ingress.csr -subj &quot;/CN=kube-ingress&quot; -config openssl.cnf</span><br><span class="line">openssl x509 -req -in ingress.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out ingress.pem -days 365 -extensions v3_req -extfile openssl.cnf</span><br></pre></td></tr></table></figure><h3 id="创建-Secret"><a href="#创建-Secret" class="headerlink" title="创建 Secret"></a>创建 Secret</h3><p>创建好证书以后，需要将证书内容放到 secret 中，secret 中全部内容需要 base64 编码，然后注意去掉换行符(变成一行)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim ingress-secret.yml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM5akNDQWQ2Z0F3SUJBZ0lKQU5TR2dNNnYvSVd5TUEwR0NTcUdTSWIzRFFFQkJRVUFNQkl4RURBT0JnTlYKQkFNTUIydDFZbVV0WTJFd0hoY05NVGN3TXpBME1USTBPRFF5V2hjTk1UZ3dNekEwTVRJME9EUXlXakFYTVJVdwpFd1lEVlFRRERBeHJkV0psTFdsdVozSmxjM013Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUM2dkNZRFhGSFpQOHI5Zk5jZXlkV015VVlELzAwQ2xnS0M2WjNpYWZ0QlRDK005TmcrQzloUjhJUE4KWW00cjZOMkw1MmNkcmZvQnBHZXovQVRIT0NJYUhJdlp1K1ZaTzNMZjcxZEVLR09nV21LMTliSVAzaGpSeDZhWQpIeGhEVWNab3ZzYWY1UWJHRnUydEF4L2doMTFMdXpTZWJkT0Y1dUMrWHBhTGVzWWdQUjhFS0cxS0VoRXBLMDFGCmc4MjhUU1g2TXVnVVZmWHZ1OUJRUXExVWw0Q2VMOXhQdVB5T3lMSktzbzNGOEFNUHFlaS9USWpsQVFSdmRLeFYKVUMzMnBtTHRlUFVBb2thNDRPdElmR3BIOTZybmFsMW0rMXp6YkdTemRFSEFaL2k1ZEZDNXJOaUthRmJnL2NBRwppalhlQ01xeGpzT3JLMEM4MDg4a0tjenJZK0JmQWdNQkFBR2pTakJJTUM0R0ExVWRFUVFuTUNXQ0VtUmhjMmhpCmIyRnlaQzV0Y21sMFpDNXRaWUlQYTJsaVlXNWhMbTF5YVhSa0xtMWxNQWtHQTFVZEV3UUNNQUF3Q3dZRFZSMFAKQkFRREFnWGdNQTBHQ1NxR1NJYjNEUUVCQlFVQUE0SUJBUUNFN1ByRzh6MytyaGJESC8yNGJOeW5OUUNyYVM4NwphODJUUDNxMmsxUUJ1T0doS1pwR1N3SVRhWjNUY0pKMkQ2ZlRxbWJDUzlVeDF2ckYxMWhGTWg4MU9GMkF2MU4vCm5hSU12YlY5cVhYNG16eGNROHNjakVHZ285bnlDSVpuTFM5K2NXejhrOWQ1UHVaejE1TXg4T3g3OWJWVFpkZ0sKaEhCMGJ5UGgvdG9hMkNidnBmWUR4djRBdHlrSVRhSlFzekhnWHZnNXdwSjlySzlxZHd1RHA5T3JTNk03dmNOaQpseWxDTk52T3dNQ0h3emlyc01nQ1FRcVRVamtuNllLWmVsZVY0Mk1yazREVTlVWFFjZ2dEb1FKZEM0aWNwN0sxCkRPTDJURjFVUGN0ODFpNWt4NGYwcUw1aE1sNGhtK1BZRyt2MGIrMjZjOVlud3ROd24xdmMyZVZHCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><br><span class="line">  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdXJ3bUExeFIyVC9LL1h6WEhzblZqTWxHQS85TkFwWUNndW1kNG1uN1FVd3ZqUFRZClBndllVZkNEeldKdUsramRpK2RuSGEzNkFhUm5zL3dFeHpnaUdoeUwyYnZsV1R0eTMrOVhSQ2hqb0ZwaXRmV3kKRDk0WTBjZW1tQjhZUTFIR2FMN0duK1VHeGhidHJRTWY0SWRkUzdzMG5tM1RoZWJndmw2V2kzckdJRDBmQkNodApTaElSS1N0TlJZUE52RTBsK2pMb0ZGWDE3N3ZRVUVLdFZKZUFuaS9jVDdqOGpzaXlTcktOeGZBREQ2bm92MHlJCjVRRUViM1NzVlZBdDlxWmk3WGoxQUtKR3VPRHJTSHhxUi9lcTUycGRadnRjODJ4a3MzUkJ3R2Y0dVhSUXVhelkKaW1oVzRQM0FCb28xM2dqS3NZN0RxeXRBdk5QUEpDbk02MlBnWHdJREFRQUJBb0lCQUJtRmIzaVVISWVocFYraAp1VkQyNnQzVUFHSzVlTS82cXBzenpLVk9NTTNLMk5EZUFkUHhFSDZhYlprYmM4MUNoVTBDc21BbkQvMDdlQVRzClU4YmFrQ2FiY2kydTlYaU5uSFNvcEhlblFYNS8rKys4aGJxUGN6cndtMzg4K0xieXJUaFJvcG5sMWxncWVBOW0KVnV2NzlDOU9oYkdGZHh4YzRxaUNDdmRETDJMbVc2bWhpcFRKQnF3bUZsNUhqeVphdGcyMVJ4WUtKZ003S1p6TAplYWU0bTJDR3R0bmNyUktodklaQWxKVmpyRWoxbmVNa3RHODFTT3QyN0FjeDRlSnozbmcwbjlYSmdMMHcwU05ZCmlwd3I5Uk5PaDkxSGFsQ3JlWVB3bDRwajIva0JIdnozMk9Qb2FOSDRQa2JaeTEzcks1bnFrMHBXdUthOEcyY00KLzY4cnQrRUNnWUVBN1NEeHRzRFFBK2JESGdUbi9iOGJZQ3VhQ2N4TDlObHIxd2tuTG56VVRzRnNkTDByUm1uZAp5bWQ4aU95ME04aUVBL0xKb3dPUGRRY240WFdWdS9XbWV5MzFVR2NIeHYvWlVSUlJuNzgvNmdjZUJSNzZJL2FzClIrNVQ1TEMyRmducVd2MzMvdG0rS0gwc0J4dEM3U2tSK3Y2UndVQk1jYnM3c0dUQlR4NVV2TkVDZ1lFQXlaaUcKbDBKY0dzWHhqd1JPQ0FLZytEMlJWQ3RBVmRHbjVMTmVwZUQ4bFNZZ3krZGxQaCt4VnRiY2JCV0E3WWJ4a1BwSAorZHg2Z0p3UWp1aGN3U25uOU9TcXRrZW04ZmhEZUZ2MkNDbXl4ZlMrc1VtMkxqVzM1NE1EK0FjcWtwc0xMTC9GCkIvK1JmcmhqZW5lRi9BaERLalowczJTNW9BR0xRVFk4aXBtM1ZpOENnWUJrZGVHUnNFd3dhdkpjNUcwNHBsODkKdGhzemJYYjhpNlJSWE5KWnNvN3JzcXgxSkxPUnlFWXJldjVhc0JXRUhyNDNRZ1BFNlR3OHMwUmxFMERWZWJRSApXYWdsWVJEOWNPVXJvWFVYUFpvaFZ0U1VETlNpcWQzQk42b1pKL2hzaTlUYXFlQUgrMDNCcjQ0WWtLY2cvSlplCmhMMVJaeUU3eWJ2MjlpaWprVkVMRVFLQmdRQ2ZQRUVqZlNFdmJLYnZKcUZVSm05clpZWkRpNTVYcXpFSXJyM1cKSEs2bVNPV2k2ZlhJYWxRem1hZW1JQjRrZ0hDUzZYNnMyQUJUVWZLcVR0UGxKK3EyUDJDd2RreGgySTNDcGpEaQpKYjIyS3luczg2SlpRY2t2cndjVmhPT1Z4YTIvL1FIdTNXblpSR0FmUGdXeEcvMmhmRDRWN1R2S0xTNEhwb1dQCm5QZDV0UUtCZ0QvNHZENmsyOGxaNDNmUWpPalhkV0ZTNzdyVFZwcXBXMlFoTDdHY0FuSXk5SDEvUWRaOXYxdVEKNFBSanJseEowdzhUYndCeEp3QUtnSzZmRDBXWmZzTlRLSG01V29kZUNPWi85WW13cmpPSkxEaUU3eFFNWFBzNQorMnpVeUFWVjlCaDI4cThSdnMweHplclQ1clRNQ1NGK0Q5NHVJUmkvL3ZUMGt4d05XdFZxCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br></pre></td></tr></table></figure><blockquote><p>kubectl create -f ingress-secret.yml</p></blockquote><h3 id="快速创建-Secret"><a href="#快速创建-Secret" class="headerlink" title="快速创建 Secret"></a>快速创建 Secret</h3><blockquote><p>kubectl create secret tls ingress-secret –key cert/ingress-key.pem –cert cert/ingress.pem</p></blockquote><h3 id="重新部署"><a href="#重新部署" class="headerlink" title="重新部署"></a>重新部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard-kibana-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - dashboard.mritd.me</span><br><span class="line">    - kibana.mritd.me</span><br><span class="line">    secretName: ingress-secret</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.mritd.me</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 80</span><br><span class="line">  - host: kibana.mritd.me</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kibana-logging</span><br><span class="line">          servicePort: 5601</span><br></pre></td></tr></table></figure><p><strong>注意:</strong><br>一个 Ingress 只能使用一个 secret(secretName 段只能有一个)，也就是说只能用一个证书，更直白的说就是如果你在一个 Ingress 中配置了多个域名，那么使用 TLS 的话必须保证证书支持该 Ingress 下所有域名；并且这个 secretName 一定要放在上面域名列表最后位置，否则会报错 <code>did not find expected key</code>无法创建；同时上面的 hosts 段下域名必须跟下面的 rules 中完全匹配</p><p><strong>更需要注意一点：</strong><br>Kubernetes Ingress 默认情况下，当你不配置证书时，会默认给你一个 TLS 证书的，也就是说你 Ingress 中配置错了，比如写了2个 secretName、或者 hosts 段中缺了某个域名，那么对于写了多个 secretName 的情况，所有域名全会走默认证书；对于 hosts 缺了某个域名的情况，缺失的域名将会走默认证书，部署时一定要验证一下证书，不能 “有了就行”；更新 Ingress 证书可能需要等一段时间才会生效</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://mritd.me/2017/03/04/how-to-use-nginx-ingress/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="noopener">Kubernetes Nginx Ingress 教程</a></p></div><div class="post-footer"><div>转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">ChaosCoffee</a></div><div></div></div></article><div class="article-nav prev-next-wrap clearfix"><a href="/2018/08/07/Kubernetes-搭建本地环境/" class="next-post btn btn-default" title="Kubernetes-搭建本地环境"><span class="hidden-lg">下一篇</span> <span class="hidden-xs">Kubernetes-搭建本地环境</span><i class="fa fa-angle-right fa-fw"></i></a></div></main><aside id="article-toc" role="navigation" class="col-md-4"><div class="widget"><h3 class="title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ingress-实践"><span class="toc-text">Ingress 实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes-暴露服务方式"><span class="toc-text">Kubernetes 暴露服务方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadBlancer-Service"><span class="toc-text">LoadBlancer Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodePort-Service"><span class="toc-text">NodePort Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ingress"><span class="toc-text">Ingress</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ingress-介绍"><span class="toc-text">Ingress 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ingress-部署"><span class="toc-text">Ingress 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#default-backend"><span class="toc-text">default-backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ingress-Controller"><span class="toc-text">Ingress Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速部署"><span class="toc-text">快速部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建相关资源"><span class="toc-text">创建相关资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建ingress-nginx服务"><span class="toc-text">创建ingress-nginx服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置TLS-SSL访问"><span class="toc-text">配置TLS SSL访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建证书"><span class="toc-text">创建证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-Secret"><span class="toc-text">创建 Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速创建-Secret"><span class="toc-text">快速创建 Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重新部署"><span class="toc-text">重新部署</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文档"><span class="toc-text">参考文档</span></a></li></ol></li></ol></div></aside></div></div></section><footer class="main-footer"><div class="container"><div class="row"><div style="text-align:center"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">Total&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;views. 您是本站的第<span id="busuanzi_value_site_uv"></span>个小伙伴&nbsp;|<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> &nbsp;Hits</div></div></div></footer><a id="back-to-top" class="icon-btn hide"><i class="fa fa-chevron-up"></i></a><div class="copyright"><div class="container"><div class="row"><div class="col-sm-12"><span>Copyright &copy; 2017</span> | <span>Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a></span> | <span>Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a></span></div></div></div></div><script src="/js/app.js?rev=26a1b6fecd389c0121b7027a299aa7c0"></script></body></html>